<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="../../css/sm.css" rel="stylesheet" />
    <link href="../../fonts/iconfont.css" rel="stylesheet" />
    <link href="../../css/app/common.css" rel="stylesheet" />
</head>
<style>
    my-nav {
        bottom: 0;
        width: 100%;
        height: 2.5rem;
        position: absolute;
        background-color: #f7f7f8;
        z-index: 11;
        box-shadow: 0 1px 6px #ccc;
    }

    my-nav~.content {
        bottom: 2.5rem;
    }
</style>

<body>
    <div class="page-group">
        <div class="page">
            <my-nav :active="activeTab" :ishidebadgeprop="isHideBadge" :biddingnumprop="biddingNum"></my-nav>
        </div>
    </div>

    <script src="../../js/libs/vue.min.js"></script>
    <script src="../../js/components.js"></script>
    <script src="../../js/sm.js"></script>
    <script src="../../js/mui.js"></script>
    <script src="../../js/app.js"></script>
    <script src="../../js/i18n.js"></script>

    <script type="text/javascript">
        window.app.ready(function (mui) {

            var vm = new Vue({
                el: ".page",
                data: {
                    activeTab: "home",
                    isHideBadge: true,
                    biddingNum: 0
                },
                mounted: function () {
                    app.customBack = mui.back
                    var preTime = 0
                    mui.back = function () {
                        var visible = $('.popup').css('display')
                        if (visible === 'block') {
                            $.closeModal('.popup');
                        } else if (vm.$children[0].activeTab == "home") {
                            mui.fire(plus.webview.getWebviewById("home"), 'refreshFire')
                            var now = new Date().getTime();
                            if (now - preTime > 2000) {
                                preTime = now;
                                mui.toast(app.i18n.CLICK_EXIT);
                            } else {
                                if (window.plus) {
                                    // var main = plus.android.runtimeMainActivity();
                                    // main && main.moveTaskToBack(false);
                                    plus.runtime.quit();
                                }
                            }
                        } else {
                            vm.$children[0].toNavPage("home")
                        }
                    };

                    var that = this;
                    this.checkForUpdates(function () {
                        $.init();
                        var Index = 0;
                        //把子页的路径写在数组里面
                        var subpages = ['home', 'find-tab', 'mine'];
                        var activeTab = subpages[Index];
                        var self = plus.webview.currentWebview();
                        for (var i = 0; i < 3; i++) {
                            var time = new Date().getTime();
                            var url = ""
                            if (subpages[i] == "find-tab") {
                                url = app.serverRoot + "/m/f-driver/pages/zh-cn/" +
                                    subpages[i] + ".html?token=" + encodeURIComponent(app.getStoredItem(
                                        'token')) + "&mobile=" + encodeURIComponent(app.getStoredItem(
                                        'mobile')) + "&time=" + time;
                            } else {
                                url = subpages[i] + ".html"
                            }
                            var sub = plus.webview.create(url, subpages[i], {
                                top: 0, //设置距离顶部的距离
                                bottom: $(".bar.bar-tab").height() + 'px' //设置距离底部的距离
                            });
                            //如不是我们设置的默认的子页则隐藏，否则添加到窗口中
                            sub.hide();
                            //将webview对象填充到窗口
                            self.append(sub);
                        }

                        plus.webview.show(that.activeTab);
                    })
                },
                methods: {
                    checkForUpdates: app.checkForUpdates
                }
            })

            window.addEventListener('refreshOrderNumber', function (event) {
                console.log("refreshOrderNumber")
                var num = event.detail.orderNumber,
                    isHideBadge = false;
                if (num <= 0) {
                    isHideBadge = true;
                }
                vm.$set(vm.$data, "isHideBadge", isHideBadge);
                vm.$set(vm.$data, "biddingNum", num);
            });

            window.addEventListener('toLoginFire', function (event) {
                app.navigate('login.html')
            });

            window.addEventListener('refreshFire', function (event) {
                vm.$children[0].toNavPage("home")
            });

            window.addEventListener('switchTabFire', function (event) {
                vm.$children[0].toNavPage(event.detail.pageId)
            });

            window.addEventListener('refreshNavFire', function (event) {
                vm.$children[0].getNav()
            });

            window.addEventListener('taskDetailPhotographUpload', function (event) {
                var path = event.detail.path,
                    currentIds = event.detail.currentIds,
                    taskDetailPage = plus.webview.getWebviewById("task-detail");
                app.compressImage(path, function (e) {
                    app.uploadFiles('/upload/image_v2', e.target, {
                        ctnid: currentIds,
                        id: currentIds ? currentIds : ''
                    }, function () {
                        mui.fire(taskDetailPage, 'successPhotographUpload', {});
                    }, function () {
                        mui.fire(taskDetailPage, 'errorPhotographUpload', {});
                    })
                }, function (e) {
                    mui.fire(taskDetailPage, 'errorPhotographUpload', {});
                })
            })
        })
    </script>
</body>

</html>