<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../css/sm.css" rel="stylesheet" />
		<link href="../../fonts/iconfont.css" rel="stylesheet" />
		<link href="../../css/app/common.css" rel="stylesheet" />
		<link href="../../css/app/detail.css" rel="stylesheet" />
		<style type="text/css">
			.list-group {
				width: 100%;
			}
			
			.mine-banner,
			.list-block {
				margin-top: 0;
			}
			
			.mine-banner {
				height: 40%;
				background-color: #263846;
				background-image: url(../../img/zh-cn/bg_pe_center.png);
				background-size: 100%;
				padding: 0;
				background-position: bottom;
				background-repeat: no-repeat;
				position: relative;
			}
			
			.mine-banner .avatar {
				border-radius: 50%;
				width: 3rem;
				height: 3rem;
				background-image: url(../../img/zh-cn/avatar.png);
				background-size: 100%;
				margin: auto;
			}
			
			.mine-banner .name {
				text-align: center;
				color: white;
			}
			
			.item-content .icon-media {
				width: 20px;
			}
			
			.item-content .item-title {
				width: 100%;
			}
			
			.item-content .item-title a {
				width: 100%;
				display: inline-block;
			}
		</style>
	</head>

	<body>
		<div class="page-group">
			<div class="page">
				<header class="bar bar-nav bg-263846" style="box-shadow: none;">
					<h1 class="title">我</h1>
				</header>

				<div class="content">
					<div class="mine-banner box justify-content-center">
						<div style="margin-bottom: 25px;">
							<div class="avatar"></div>
							<div class="name"></div>
						</div>
						<div style="position: absolute; top: 0; right: 0; color:aliceblue; font-size: 0.4rem;" class="d-n" id="qaInfo"></div>
						<div id="qaBtn" style="position: absolute; bottom: 30px; right: 0;opacity: 0;">111</div>
					</div>
					<div class="js-mine-box"></div>
				</div>
			</div>
		</div>
		<script src="../../js/libs/vue.min.js"></script>
		<script src="../../js/components.js"></script>
		<script src="../../js/util.js"></script>
		<script src="../../js/mui.js"></script>
		<script src="../../js/sm.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/i18n.js"></script>
		<script src="../../js/handlebars.min.js"></script>
		<script type="text/x-handlebars-template" id="js-mine-template">
			{{#each objs}}
			<div class="list-block media-list" {{#if isTell}}onclick="app.callphone('{{phone}}',this)" {{/if}}{{#if isH5Page}}es-href-outer="{{pageId}}" {{/if}}{{#if isHrefShow}}es-href="{{pageId}}" {{/if}} {{#if isRecord}}data-record="true" data-key="{{recordKey}}" {{/if}}>
				<ul>
					<li>
						<div class="item-content">
							<div class="item-media"><i class="iconfont {{icon}}"></i></div>
							<div class="item-inner">
								<div class="item-title-row">
									<div class="item-title">
										<a class="color-default">{{name}}</a>
									</div>
								</div>
							</div>
						</div>
					</li>
				</ul>
			</div>
			{{/each}}
		</script>
		<script type="text/javascript">
			window.app.ready(function(mui) {
				this.query = function() {
					app.ajaxGetNeedLogin('/driver/info', {}, this.queryCallback)
				}
				this.queryCallback = function(res) {
					app.ajaxGetNeedLogin('/h5Config', {}, function(config) {
						app.unmask();
						var h5Template = Handlebars.compile($("#js-mine-template").html());
						$.each(config.objs, function(_, v) {
							if(v.type == "TELL") {
								config.objs[_].isTell = true;
								config.objs[_].isH5Page = false;
							}
							if(v.type != "TELL" && !v.isH5Page) {
								config.objs[_].isHrefShow = true;
							}
						});
						$(".js-mine-box").html(h5Template(config));
						app.setStoredItem('name', res.name)
						$('.name').html(res.name)
					})
				}
				$('.name').html(app.getStoredItem('name'))

				$('.content').on('tap', '#signoutBtn', function() {
					app.ajaxGet('/logout', {}, function() {
						app.removeStoredItem('mobile')
						app.removeStoredItem('token')
						app.navigate('login.html');
					})
				})

				window.addEventListener('fireInit', function(event) {
					$('.name').html(app.getStoredItem('name'))
				});

				$("#qaInfo").html(
					app.serverRoot + "<br>" +
					app.chromeDebug + "<br>" +
					JSON.stringify(app.project) + "<br>" +
					app.version + "<br>" +
					app.appIdentify + "<br>" +
					app.serverJidan + "<br>" +
					app.huanhuo + "<br>" +
					app.locale
				)

				$("#qaBtn").on("click", function() {
					$("#qaInfo").removeClass("d-n")
				})
				app.query()
				window.addEventListener('refreshFire', function(event) {
					app.checkForUpdates(function(){
						app.query();
					})
				})
				
				window.addEventListener('updateInfo', function(event) {
					var res = event.detail;
					$("#editBtn").addClass("icon-edit edit").removeClass("icon-wrong");
					if(window.plus) {
						var toPage = plus.webview.getWebviewById("mine")
						app.query();
					}
				})

				window.addEventListener('platformPay', function(event) {
					var type = event.detail.type,
						value = event.detail.value,
						channel = null,
						alipay = null,
						weixin = null,
						ALIPAYSERVER = '/containerLoad/alipay/recharge',
						WXPAYSERVER = '/weChat/orderPayment',
						payPage = plus.webview.getWebviewById("recharge");
					var pay = function(type, value) {
						var PAYSERVER = '';
						if(type == 'alipay') {
							PAYSERVER = ALIPAYSERVER;
							channel = alipay
						} else if(type == 'wxpay') {
							PAYSERVER = WXPAYSERVER;
							channel = weixin
						} else {
							mui.fire(payPage, 'payTypeError', {});
							return;
						}
						//pay success
						var getOrderSuccess = function(res) {
							console.log(JSON.stringify(res))
							if(res.success) {
								var paymentData = res.obj.value ? res.obj.value : res.obj;
								console.log(JSON.stringify(paymentData));
								plus.payment.request(channel, paymentData, function(result) {
									mui.fire(payPage, 'paySuccess', {});
								}, function(error) {
									mui.fire(payPage, 'payError', {
										error: error
									});
								});
							} else {
								mui.fire(payPage, 'autographError', {});
							}
						}

						if(PAYSERVER === WXPAYSERVER) {
							app.ajaxGet(PAYSERVER, {
								amount: value
							}, getOrderSuccess, function() {
								mui.fire(payPage, 'getOderError', {});
							})
						} else {
							app.ajaxPost(PAYSERVER, {
								amount: value
							}, getOrderSuccess, function() {
								mui.fire(payPage, 'getOderError', {});
							})
						}
					}
					plus.payment.getChannels(function(channels) {
						alipay = channels[0];
						weixin = channels[1];
						pay(type, value);
					}, function(e) {
						console.log("获取支付通道失败：" + e.message);
					});
				});

				window.addEventListener('logout', function(event) {
					app.ajaxGet('/logout', {}, function() {
						app.removeStoredItem('mobile')
						app.removeStoredItem('token')
						mui.openWindow({
							url: 'login.html',
							id: 'login.html',
							extras: {
								isHideIndex: true
							}
						});
					})
				});
			})
		</script>
	</body>

</html>